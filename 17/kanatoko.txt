x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x
x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x

--- 第5章: hostsファイルの名前変更 ---

著者：金床

x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x
x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x


■0x01.) はじめに

　ここ数ヶ月の間に、一般ユーザのクライアントPCを狙ったフィッシング詐欺が
注目されるようになりました。最も代表的な攻撃は電子メールを使った一本釣り
ですが、DNSや名前解決の仕組みを狙う、さらに狡猾な攻撃も発見されています。
この名前解決の仕組みに対して攻撃を受けると、ウェブブラウザのURL入力欄に正
しいURLを入力したにも関わらず偽のサイトに接続してしまうという、やっかいな
現象に遭遇します。

　これらの名前解決に対する攻撃として、DNSポイゾニングとhostsファイルへの
書き込みという2つの手法が確認されています。DNSポイゾニングはDNSサーバーに
対して偽の情報を送りつける攻撃方法です。ここでは詳細は省略します。一方の
hostsファイルへの書き込みは、UNIX系OSにもWindows系OSにも存在する"hosts"と
いうファイルに偽の情報を書き込み、そのマシンからのアクセスを一部制御して
しまうものです。


■0x02.) hostsファイルとは？

　UNIX系OSの場合、hostsファイルは/etcの下にあります。Windows系OSの場合に
はC:\WINNT\system32\drivers\etcなどにあります。ファイルはテキストファイル
であり、通常はテキストエディタで編集して使います。次のようにIPアドレスと
それに対応するホスト名をスペースやタブで区切った形でひとつのエントリを形
成し、これを必要に応じて随時追加、削除して使います。下の例のように記述し
た場合、このマシンにおいて「localhost」というホスト名はIPアドレス「127.0
.0.1」に対応付けされます。私自身はプライベートアドレスに対して仮の名前を
付けて名前解決によって「時が止まる（WB16参照）」のを防いだり、ウェブサー
バーでバーチャルホストのテストを行う際などにhostsファイルを使用しています。

-----
127.0.0.1       localhost
192.168.0.1	gateway
-----


■0x03.) hostsファイルの書き換え

　攻撃者はこのhostsファイルに、次のように偽のエントリを追加します。ここで
218.45.25.195は攻撃者がフィッシングサイトや盗聴用のプロキシサーバーをセッ
ティングした、罠サーバーのIPアドレスだとします。

-----
218.45.25.195		www.bank.com
-----

　hostsファイルの内容はDNSサーバーへの問い合わせより優先されてしまうため、
このエントリが追加されたPCでhttp://www.bank.com/にアクセスしようとすると、
218.45.25.195に接続してしまいます。ウェブサイトがSSLを使用している場合に
は攻撃者は正しい証明書を持っていないため、ウェブブラウザが警告のダイアロ
グを出してくれるでしょう。そのような意味では、WB15で紹介した「ルート証明
書のインストールとプロキシサーバー設定の書き換え」に比べ、ややインパクト
に欠ける攻撃でもあります。


■0x04.) 防御手段

　hostsファイルへの偽エントリの追加は、ファイル自身のパーミッションの変更
（読みとり専用にするなど）や、hostsファイルの書き換えを監視するソフトウェ
アの導入などでも防ぐことができます。しかし、これらは抜本的な対策とはいえ
ない気がします。そこで、今回WBの場を借りて一風変わった防御手段を提案しま
す。それは、「hostsファイルのファイル名の変更」です。

　hostsファイルはどのマシンでも必ず「hosts」という名前なので、書き換えを
狙うウイルスやワームも必ず「hosts」という名前のファイルを書き換えます。そ
こで、自分のマシンだけはhostsファイルの名前を「posts」のように別の名前に
してしまうのです。そして、もちろん偽のhostsファイルを「hosts」という名前
で置いておきます。これでウイルスやワームに感染して「hosts」という名前のフ
ァイルを書き換えられても、痛くも痒くもないというわけです。このように自分
のシステムにおいて「おきまりの」名前を変更するという作戦は、小細工ながら
も有効な防御手段だと言えます。似たような作戦として、"/bin/sh"をシェル以外
の無害なスクリプトなどに置き換えることで、"/bin/sh"を含んだシェルコードに
よる攻撃を無害化する、などの防御手段も考えられます。


■0x05.) 誰が名前を決めているのか？

　ここから先は、OSとしてWindows2000を想定して解説を行います。おそらく他の
Windows系OSも似たようなものだと思います。以下の情報はシステムを不安定にさ
せたりする可能性を持っているので、全て自己責任において使用して下さい。と
ここに来ておきまりの文句を（笑。

　hostsファイルの名前を「hosts」だと決めているのは一体誰なのか。まずはそ
れを調べなければなりません。私も最初は調べてみるつもりだったのですが、掲
示板でどこかの親切なハカーが「dnsrslvr.dllにhostsファイルのモニタスレッド
があるみたいですよ。」と教えてくれました。モニタスレッドとは、hostsファイ
ルの更新を見張っている、プログラム中の一つのスレッドを指します。この情報
を教えてもらった後に、「dnsrslvr.dll」というhostsファイルの名前を変更する
ために非常に重要になるキーワードにたどり着くための手段を調べてみたので、
ここで紹介します。まず、Filemonという有名なフリーツールを使用します。この
ツールを使うとありとあらゆるファイルに対するアクセスを見張ることができま
す。このツールを起動した状態でhostsファイルの書き換えを行ってみると、ser
vices.exeというプロセスがファイルの更新を見張っていることが分かります。s
ervices.exeというのはWindowsシステムにおいて名前解決全般を担当しているサ
ービスの実体であり、このことからこのservices.exeが「hosts」というキーワー
ドを持っているのではないかという疑いを持つことができます。そこで、次にOl
lyDbgでservices.exeをattachし、メモリを「drivers\etc\hosts」というキーワ
ードで検索します。すると見事に「dnsrslvr.dll」というキーワードにたどり着
くことができます。

○Filemon
http://www.sysinternals.com/ntw2k/source/filemon.shtml

○OllyDbg
http://home.t-online.de/home/Ollydbg/


■0x05.) [k]

　dnsrslvr.dllはOSがインストールされているフォルダの中の、system32の中に
あります。DLLファイルをバイナリエディタで開き「hosts」で検索すると、0x3D
50付近に「hosts」の文字列を確認することができます。これこそがWindowsオペ
レーティングシステムにおけるhostsファイルの名前を「hosts」に決定している
正体です。では、これを別の名前に書き換えてしまいましょう。dnsrslvr.dllは
services.exeによって使用されているために、通常の状態では上書きすることが
できません。そこで、上書きするにはservices.exeを止める必要があります。

　services.exeを停止するための正しい手順が（あるのかどうかも）わからなか
ったので、強引に止めることにしました。OllyDbgでAttackした後に、Alt+F2でC
loseを行います。これでservices.exeを停止させることができます。しかしserv
ices.exeが停止するとOSがこれを異常事態として認識してしまい、60秒後に強引
に再起動が行われることになります。ですので、dnsrslvr.dllの上書きはこの60
秒の間に済ませる必要があります。前もってhostsの文字列を変更したDLLのコピ
ーを用意しておき、services.exeを停止させたらすぐに上書きするようにしてお
けば良いでしょう。これで、再起動後には無事にhostsファイルの名前が変更され
ます。新しくあなたが決めた名前のファイルを従来のhostsファイルと同じフォル
ダ内に作成し、動作を確認してみてください。


■0x06.) まとめ

　これで対策は万全なのでしょうか？　hostsファイルを書き換えようとする攻撃
者、あるいはワームやウイルスがdnsrslvr.dllの中身まで確認してしまえば、こ
の作戦も役に立たないことになります。しかし現状hostsファイルの名前を変更す
るなどという奇策を採っている人は非常に稀だと思われるので、攻撃者がそこま
で想定している可能性はとても低いと言えるでしょう。しかしさらに万全を期し
たい場合には、このhostsファイルの名前変更と共に、ファイルの更新を見張るツ
ールなどを併用すると良いと思います。
