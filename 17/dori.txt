x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x
x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x

--- 第8章: 吉里吉里２で作成されたソフトの解析 ---

著者：dori

x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x
x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x


■0x01.) はじめに

　今回何か書いてみようと思い立ちましたが、普通のものを解説しても面白くな
いであろうと思い、今まで表に情報が出ていないものを題材にしてみることにしました。
○題材となるもの：「吉里吉里２」
http://kikyou.info/tvp/

　これで作られたソフトかどうか判断するにはバイナリエディタで吉里吉里とい
う文字列を検索してみるのが確実です。終了時のダイアログが特徴的ですので、
そこで気付くかもしれません。

　吉里吉里とは、アドベンチャーゲームやノベルゲームでよく使われる開発ソフ
トであり、TJSというスクリプト言語で開発することができます。これで開発され
ている商用のゲームもいくつかあり、最近使用する人が増えてきています。

　このように本体でスクリプト言語を解釈して実行されているようなソフトの場
合、Ollydbgなどのデバッガを使用して解析しようとしても本体は解析可能なので
すが、その本体で解釈しているスクリプトの命令まではチェックしにくいです。
　通常のデバッガがまともに使えないソフトの場合には他の手段を探してみてく
ださい。新しい分野でなければ、先駆者の手により専用のデバッガや逆アセンブ
ラが、作られている可能性が高いと思われますので、試しに検索してみてくださ
い。
　もし、ツールが見つかったのであればそれを試してみましょう。このように手
抜きができる部分があるのでしたら素直に手を抜くことも大切です。最初から全
部自分でやろうとするとかなりの困難が予想されます。

　試しに吉里吉里で使えそうなツールがないかチェックしてみたのですがほとん
ど見つかりません。元々フリーのアドベンチャーを作る人が多いソフトなので余
り解析を行ってみようという人が少ないこともひとつの原因でしょう。

　もし、自分で一から解析を行ってみようとする場合、まずソフトの開発ツール
を手に入れてみてください。今回のものですと、吉里吉里２となります。

○吉里吉里２ SDK
http://kikyou.info/tvp/

　安定版をダウンロードしてください。現在の最新バージョンはVer2.24です。
　なぜ開発ツールからダウンロードしてもらうのかというと、開発ツールにはデバッガがついているものも多いですし、ヘルプファイルなどをチェックすることにより解析を行う道しるべが見つかる可能性が高いからです。


■0x02.) 吉里吉里で作成されたソフトの解析

　では、吉里吉里で作成されたファイルを解析していくことにしましょう。通常、
吉里吉里で作成したファイルはスクリプトファイルの状態なのですが、これを実
行する場合に本体が必要となりますし、何より実行方法が初心者向きとはいえま
せん。ですので、通常は実行ファイル形式で配布出来るように変換が行われてい
ます。

　以下が吉里吉里で作成された実行ファイルです。

http://akademeia.info/wizardbible/17/file/crk_01.exe

　実行してみると、パスワードを入力するように求められますので、適当なパス
ワードを入力してみると、違いますと怒られてしまいました。正しいパスワード
を導きだすにはどうすればよいでしょうか？

　困ったときは開発ツールのマニュアルをチェックしてみましょう。kirikiri2\
kr2doc\contents\index.htmlがマニュアルとなります。概要と各機能の部分にデ
バッグという気になるものが見つかりましたので、チェックしてみましょう。

　どうやら吉里吉里にはデバッグ支援ウィンドウがあるようです。その中でもコ
ンソール（[Shift]＋[F4]）というものが面白そうな機能です。

　crk_01.exeを再度実行して、試してみましょう。起動直後に、コンソール（[S
hift]＋[F4]）を押してみると、通常の画面に表示されないような文字列も見える
ようです。パスワードを前回と同じように適当に入力してみると、コンソールウ
インドウに文字列が表示され、それを確認してみるとif文で何やら怪しげな文字
列と比較している部分が見つかります。試しに怪しげな文字列を入力してみてく
ださい。見事に正解メッセージが表示されたことと思います。

　では、続いて次のものも試してみてください。

http://akademeia.info/wizardbible/17/file/crk_02.exe

　同じように起動後に、コンソール（[Shift]＋[F4]）を表示させようとするの
ですが、コンソール画面が表示されません。コントローラも表示できないようで
す。どうやら対策されたバージョンのようです。

　再度マニュアルでデバッガの項目を確認してみます。どうやらコマンドライン
オプションで色々な機能を設定することができるようです。さらに見ていくと、
krkrconf.exeにてオプションの指定を変更することも可能と書かれています。

○吉里吉里設定用プログラム
kirikiri2\tools\krkrconf.exe

　krkrconf.exeを実行するとexeファイルを選択する画面が出てきますので、crk
_02.exeを選択します。色々なオプション設定が表示されますが、興味あるのはデ
バッグの部分ですので、それを探してみてください。どうやらデバッグ支援ウイ
ンドウだけが無効設定になっているようです。選択し、オプションの値を有効に
した後に、[OK]を押して設定を保存してください。
　再度、crk_02.exeを実行してみてください。コンソール（[Shift]＋[F4]）が表
示可能となっているはずです。後は同様にすれば解決できるので、省略します。


■0x03.) 解析を終えて

　今回の開発ツールはデバッガが付属されていたので判りやすいケースでした。
もし、デバッガが開発ツールに付いていない場合でも簡単なプログラムを自分で
作成し、文法を少しずつ変更させてバイナリがどのように変化するかチェックす
るような地味な作業でどうにかなる可能性は高いです。ただし、仮想マシンで動
いているようなソフトで開発ツールが手に入らないような場合ですと、解析がか
なり難しくなると思われますので諦めてしまうという選択肢も考えておくべきで
す。

　最後になりますが、この開発ツールはソースが公開されていますので、それを
読めば解析は容易であることは想像できますが他のツールへの応用のためにソー
スなしの状態と仮定して書いてみました。
