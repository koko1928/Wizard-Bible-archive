x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x
x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x

--- 第○章: IEのContent-Type無視をHackする  ---

著者：はせがわようすけ

x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x
x0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0xx0xXx0x


■0x01.) はじめに

  Wizard Bible第40号で外国人からみたスシについて話題がでていたので、ここぞ
とばかりに記事を書いてみることにしました。筆者はつい最近シアトルに行って
きたのですが、そこで聞いた外国人からみたスシの実態は、スシネタとサシーミの混同どこ
ろではなく我々の常識を大きく覆すものでした。
  彼らが「スシ」と呼ぶ、和食レストランで出されるものは、巻き寿司1本をそのま
ま衣をつけて揚げ、2cmくらいにざっくりと切ったものだそうです。
  恐るべし、スシ。えーと、なんの話だっけ。


■0x02.) つぎに

  そうそう、IEの Content-Type: 無視の話でした。
  XSSを引き起こし、Webアプリケーションの自由度を大きく引き下げることもあ
るこの悪名高きContent-Type無視がどのように発生するのか、そのメカニズムに
ついて本稿では説明します。


■0x03.) はじめに 2.0

  まず、IEの悪しき習慣「Content-Type無視」は、IEの設定「拡張子ではなく、
内容によってファイルを開くこと」を「無効」に設定しただけでは解決しません。
ユーザ側ではリスク低減のためにこの設定を「無効」にすることをお勧めします
が、Webアプリケーション側でも性質によっては対策が必須となります。
  また、IEの挙動は、レスポンスヘッダで指定されたContent-Typeが、レジスト
リの"HKCR\Mime\Database\Content Type"に登録されているかいないかで大きく変
わります。
  以降の説明では、単に「レジストリに登録されている」と書いた場合にはこの
"HKCR\Mime\Database\Content Type"に登録されていることを示します。また、「
『拡張子によって…』」と書いた場合には、「拡張子ではなく、内容によって
ファイルを開くこと」の設定を示します。
  それでは説明に詳しい説明にうつります。


■0x04. レジストリに登録されている場合

  Content-Typeがレジストリに登録されている場合、IEの挙動は概ね以下のよう
になります。

●1. IE以外のアプリケーションが処理する場合

  レジストリのCLSIDおよびExtensionから該当するアプリケーションを検索し、
そのアプリケーションがコンテンツを処理します。PDFのようにアプリケーション
がIEのプラグインとして登録されている場合には、コンテンツは無条件にそのア
プリケーション上で開かれますし、そうでない場合にはダウンロードダイアログ
が表示されます。

●2. IEが処理する場合

○2.1.「拡張子によって…」が有効な場合

  先頭256バイトをスキャンしファイルタイプが決定されます。ここでファイルタ
イプとして選ばれるものは、IE自身が処理できる形式（text/html、text/plainや
image/*など）に限られます。この場合のファイルタイプの決定においては、HTM
L としての優先順位が非常に高く、HTMLらしき文字列（<html>など）が含まれて
いた場合にはHTMLとして処理されます。

　ただし、image/gif、image/jpeg、image/pngにおいてはファイル先頭のマジッ
クバイトにより画像ファイルであることが確認されるため、HTMLらしき文字列が
含まれていても正しく画像として扱われます。一方、image/bmpおよびtext/plai
nについてはHTMLらしき文字列（<html>など）が見つかった場合にはHTMLとして処
理されます。

　image/gifやimage/jpegの場合でも、マジックバイトが一致しない場合（GIF画
像であるのにimage/jpegを返した場合なども）には、やはりファイル内容がスキ
ャンされ、高い優先度をもってHTMLではないかの判断がなされます。

○2.2.「拡張子によって…」が無効な場合

  Content-Typeに従って、IE自身がそのコンテンツを処理します。


■0x05. レジストリに未登録な場合

  Content-Typeがレジストリに登録されていない場合、IEの挙動は概ね以下に説
明するような動作になります。
  ここで、URL-ExtはURL中のlocation.pathnameの拡張子部分を、QUERY_STRINGは
URL中のlocation.search.substring(1)を指すものとします。例えば、URLが「ht
tp://example.com/search.cgi?q=text」であった場合、URL-Extは".cgi"を、QUE
RY_STRINGは"q=text"を示します。

●URL-Extが".exe"または".cgi"の場合

　拡張子としてQUERY_STRINGの末尾の"\.[A-Za-z0-9]+"が使われ、それに基づく
ファイルタイプが仮選択されます。例えば、URLが「http://example.com/search
.cgi?q=abcd.html」であった場合、拡張子は".html"となり、仮のファイルタイプ
としてはHTMLが選択されます。
  さらに、選択された仮のファイルタイプがHTMLやimage/*のようにIE自身で処理
できる種類の場合、「拡張子ではなく…」とは無関係に、2.1と同様にファイル内
容のスキャンが行われ、最終的なファイルタイプが決定されます。
  選択された仮のファイルタイプがIE自身で処理できない場合は、外部のアプリ
ケーションが起動されるか、またはダウンロードダイアログが表示されます。


●URL-Extが".exe"および".cgi"以外の場合

  拡張子としてURL-Extがそのまま使用されます。例えば、URLが「http://examp
le.com/search.do?q=abcd.html」であった場合、拡張子は".do"となり、仮のファ
イルタイプとして".do"に対応するハンドラがレジストリ中から検索されます。仮
のファイルタイプ ".do"のハンドラがIEのプラグインとなっている場合は、その
ファイルタイプが最終的なファイルタイプとなり、そのままプラグインアプリケ
ーションによって開かれます。そうでない場合にはダウンロードダイアログが表
示されます。
  また、URLが「http://example.com/search.cgi/a.html」のような場合、拡張子
は".html"となり、仮のファイルタイプとしてHTMLが選択され、レジストリから該
当するハンドラが検索されます（ここまでは上記".do"と同じ）。
  検索したハンドラがIEであり、IE自身がそのファイルを処理できる場合、「拡
張子ではなく…」とは無関係に、2.1と同様にファイル内容のスキャンが行われ、
最終的なファイルタイプが決定されます。


■0x06. さいごに

  このように、IEのContent-Type（正確にはファイルタイプ）の決定は、非常に
複雑なものとなっています。特に、IEやWindowsのバージョン、レジストリの設定
によって動作が異なる部分も多く、上述の部分でも環境によって異なることがあ
るかも知れません。
  総論的には、以下のルールを守ることでIEのContent-Typeに対しても安全なWe
bアプリケーションとなります。

・Windowsに登録されている Content-Type のみを生成する。
・image/bmp および text/plain は避ける

　特に前者については、初期状態のWindowsではPDFにも対応していないことや、
IE6では application/atom+xmlといった新しいメディアタイプにも対応していな
い点についても注意が必要です。

  本稿については、Vista上のIE7について挙動を確かめながら書いていますが、
間違いや勘違い、ツッコミやその他の環境での挙動差などがありましたら、ぜひ
ともhasegawa@utf-8.jpまでご連絡ください。


